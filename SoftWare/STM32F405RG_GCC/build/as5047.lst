ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 1


   1              		.cpu cortex-m4
   2              		.arch armv7e-m
   3              		.fpu fpv4-sp-d16
   4              		.eabi_attribute 27, 1
   5              		.eabi_attribute 28, 1
   6              		.eabi_attribute 20, 1
   7              		.eabi_attribute 21, 1
   8              		.eabi_attribute 23, 3
   9              		.eabi_attribute 24, 1
  10              		.eabi_attribute 25, 1
  11              		.eabi_attribute 26, 1
  12              		.eabi_attribute 30, 1
  13              		.eabi_attribute 34, 1
  14              		.eabi_attribute 18, 4
  15              		.file	"as5047.c"
  16              		.text
  17              	.Ltext0:
  18              		.cfi_sections	.debug_frame
  19              		.section	.text.encoder_set_error,"ax",%progbits
  20              		.align	1
  21              		.global	encoder_set_error
  22              		.syntax unified
  23              		.thumb
  24              		.thumb_func
  26              	encoder_set_error:
  27              	.LVL0:
  28              	.LFB239:
  29              		.file 1 "./Hardware/as5047.c"
   1:./Hardware/as5047.c **** #include "as5047.h"
   2:./Hardware/as5047.c **** #include "spi.h"
   3:./Hardware/as5047.c **** #include "gpio.h"
   4:./Hardware/as5047.c **** 
   5:./Hardware/as5047.c **** 
   6:./Hardware/as5047.c **** #include "stdbool.h"
   7:./Hardware/as5047.c **** #include "math.h"
   8:./Hardware/as5047.c **** typedef struct as5047_data
   9:./Hardware/as5047.c **** {
  10:./Hardware/as5047.c ****     int32_t *raw_buf;
  11:./Hardware/as5047.c ****     int32_t *covdata_buf;
  12:./Hardware/as5047.c ****     int32_t *filterdata_buf;
  13:./Hardware/as5047.c ****     int16_t buf_column;
  14:./Hardware/as5047.c **** }as5047_data_t;
  15:./Hardware/as5047.c **** static as5047_data_t sg_as5047data = {0};
  16:./Hardware/as5047.c **** int32_t rawdata,covdata,filterdata;
  17:./Hardware/as5047.c **** static int16_t column;
  18:./Hardware/as5047.c **** typedef enum
  19:./Hardware/as5047.c **** {
  20:./Hardware/as5047.c **** 	MODE_INCREMENTAL = 0,
  21:./Hardware/as5047.c **** 	MODE_SPI_AS5047P,
  22:./Hardware/as5047.c **** 	MODE_SPI_MT6701,
  23:./Hardware/as5047.c **** 	MODE_SPI_MA730,
  24:./Hardware/as5047.c **** 	MODE_SPI_TLE5012B,
  25:./Hardware/as5047.c **** } ENCODER_enum;
  26:./Hardware/as5047.c **** 
  27:./Hardware/as5047.c **** typedef struct 
  28:./Hardware/as5047.c **** {
  29:./Hardware/as5047.c **** 	ENCODER_enum  mode;
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 2


  30:./Hardware/as5047.c **** 	float  calib_range;        // Accuracy required to pass encoder cpr check
  31:./Hardware/as5047.c **** 	float  calib_scan_distance;// rad electrical
  32:./Hardware/as5047.c **** 	float  calib_scan_omega;   // rad/s electrical
  33:./Hardware/as5047.c **** 	float  bandwidth;          //ç¼–ç å™¨å¸¦å®½ï¼Œå’Œcpræˆæ­£æ¯”
  34:./Hardware/as5047.c **** 	int32_t  phase_offset;     //ç¼–ç å™¨å’Œè½¬å­ç”µè§’åº¦ä¹‹é—´çš„ç›¸ä½å·®ï¼Œrun_offset_calibratio
  35:./Hardware/as5047.c **** 	float  phase_offset_float; //ç¼–ç å™¨å’Œè½¬å­ç”µè§’åº¦ä¹‹é—´çš„ç›¸ä½å·®æµ®ç‚¹éƒ¨åˆ†ï¼Œrun_offse
  36:./Hardware/as5047.c **** 	int32_t  cpr;              //æ¯åœˆç¼–ç å™¨çš„è„‰å†²æ•°
  37:./Hardware/as5047.c **** 	float  index_offset;
  38:./Hardware/as5047.c **** 	bool  use_index;           //æ˜¯å¦ä½¿ç”¨ç¼–ç å™¨ç´¢å¼•ä¿¡å·
  39:./Hardware/as5047.c **** 	bool  pre_calibrated;      // If true, this means the offset stored in
  40:./Hardware/as5047.c **** 	                           // configuration is valid and does not need
  41:./Hardware/as5047.c ****                              // be determined by run_offset_calibration.
  42:./Hardware/as5047.c ****                              // In this case the encoder will enter ready
  43:./Hardware/as5047.c ****                              // state as soon as the index is found.
  44:./Hardware/as5047.c **** 	int32_t  direction;        //ç”µæœºè½¬åŠ¨æ–¹å‘ï¼Œrun_offset_calibration()æ ¡å‡†è¿™ä¸ªå‚æ•°
  45:./Hardware/as5047.c **** 	bool  use_index_offset;
  46:./Hardware/as5047.c **** 	bool  enable_phase_interpolation; // Use velocity to interpolate inside the count state
  47:./Hardware/as5047.c **** 	bool find_idx_on_lockin_only;     // Only be sensitive during lockin scan constant vel state
  48:./Hardware/as5047.c **** 	float phase_;              //æœ€ç»ˆç”¨äºè®¡ç®—çš„å½“å‰ç”µè§’åº¦ï¼ŒèŒƒå›´-Pi~Piã€‚
  49:./Hardware/as5047.c **** 	float phase_vel_;          //æœ€ç»ˆç”¨äºè®¡ç®—çš„å½“å‰ç”µè§’é€Ÿåº¦ï¼Œå•ä½rad/sã€‚
  50:./Hardware/as5047.c **** } ENCODER_CONFIG;
  51:./Hardware/as5047.c **** 
  52:./Hardware/as5047.c **** #define TIM_1_8_CLOCK_HZ 168000000
  53:./Hardware/as5047.c **** #define TIM_1_8_PERIOD_CLOCKS 3500
  54:./Hardware/as5047.c **** #define TIM_1_8_DEADTIME_CLOCKS 100  //100=595ns
  55:./Hardware/as5047.c **** #define TIM_APB1_CLOCK_HZ 84000000
  56:./Hardware/as5047.c **** #define TIM_APB1_PERIOD_CLOCKS 4096
  57:./Hardware/as5047.c **** #define TIM_APB1_DEADTIME_CLOCKS 50  //50=595ns
  58:./Hardware/as5047.c **** #define TIM_1_8_RCR 2
  59:./Hardware/as5047.c **** #define  ENCODER_mode        MODE_SPI_AS5047P    //ç¼–ç å™¨ç±»å‹ï¼Œå…±å››ç§:MODE_INCREMENTAL,MOD
  60:./Hardware/as5047.c **** #define  ENCODER_cpr                   16384     //AS5047P=MT6701=16384,TLE5012B=32768, MODE_INCREM
  61:./Hardware/as5047.c **** #define  ENCODER_bandwidth             1000      //é»˜è®¤1000ï¼Œhallç”µæœºçš„cpræ¯”è¾ƒå°ï¼Œå¯è®¾ç
  62:./Hardware/as5047.c **** #define M_PI  3.14159265358979323846f
  63:./Hardware/as5047.c **** #define  MOTOR_pole_pairs                          7    //ç”µæœºæå¯¹æ•°
  64:./Hardware/as5047.c **** #define CURRENT_MEAS_PERIOD ( (float)2*TIM_1_8_PERIOD_CLOCKS*(TIM_1_8_RCR+1) / (float)TIM_1_8_CLOCK
  65:./Hardware/as5047.c **** static const float current_meas_period = CURRENT_MEAS_PERIOD;
  66:./Hardware/as5047.c **** 
  67:./Hardware/as5047.c **** ENCODER_CONFIG   encoder_config;
  68:./Hardware/as5047.c **** 
  69:./Hardware/as5047.c **** static float pll_kp_ = 0.0f;   // [count/s / count]
  70:./Hardware/as5047.c **** static float pll_ki_ = 0.0f;   // [(count/s^2) / count]
  71:./Hardware/as5047.c **** 
  72:./Hardware/as5047.c **** bool pos_estimate_valid_ = false;   //ä½ç½®ä¼°ç®—æ˜¯å¦å¯ç”¨
  73:./Hardware/as5047.c **** bool vel_estimate_valid_ = false;   //é€Ÿåº¦ä¼°ç®—æ˜¯å¦å¯ç”¨
  74:./Hardware/as5047.c **** 
  75:./Hardware/as5047.c **** float pos_estimate_ = 0.0f; //å½“å‰ä¼°ç®—çš„ä½ç½®å€¼ï¼Œå•ä½[turn]
  76:./Hardware/as5047.c **** float vel_estimate_ = 0.0f; //å½“å‰ä¼°ç®—è½¬é€Ÿï¼Œå•ä½[turn/s]
  77:./Hardware/as5047.c **** 
  78:./Hardware/as5047.c **** /*****************************************************************************/
  79:./Hardware/as5047.c **** /*****************************************************************************/
  80:./Hardware/as5047.c **** static inline float wrap_pm(float x, float y) {
  81:./Hardware/as5047.c **** #ifdef FPU_FPV4
  82:./Hardware/as5047.c **** 	float intval = (float)round(x / y);  //round_int
  83:./Hardware/as5047.c **** #else
  84:./Hardware/as5047.c **** 	float intval = nearbyintf(x / y);
  85:./Hardware/as5047.c **** #endif
  86:./Hardware/as5047.c **** 	return x - intval * y;
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 3


  87:./Hardware/as5047.c **** }
  88:./Hardware/as5047.c **** static inline float fmodf_pos(float x, float y) {
  89:./Hardware/as5047.c **** 	float res = wrap_pm(x, y);
  90:./Hardware/as5047.c **** 	if (res < 0) res += y;
  91:./Hardware/as5047.c **** 	return res;
  92:./Hardware/as5047.c **** }
  93:./Hardware/as5047.c **** 
  94:./Hardware/as5047.c **** static inline float wrap_pm_pi(float x) {
  95:./Hardware/as5047.c **** 	return wrap_pm(x, 2 * M_PI);
  96:./Hardware/as5047.c **** }
  97:./Hardware/as5047.c **** 
  98:./Hardware/as5047.c **** // Modulo (as opposed to remainder), per https://stackoverflow.com/a/19288271
  99:./Hardware/as5047.c **** static inline int mod(const int dividend, const int divisor)
 100:./Hardware/as5047.c **** {
 101:./Hardware/as5047.c **** 	int r = dividend % divisor;
 102:./Hardware/as5047.c **** 	if (r < 0) r += divisor;
 103:./Hardware/as5047.c **** 	return r;
 104:./Hardware/as5047.c **** }
 105:./Hardware/as5047.c **** 
 106:./Hardware/as5047.c **** 
 107:./Hardware/as5047.c **** void encoder_set_error(uint32_t error) 
 108:./Hardware/as5047.c **** {
  30              		.loc 1 108 1 view -0
  31              		.cfi_startproc
  32              		@ args = 0, pretend = 0, frame = 0
  33              		@ frame_needed = 0, uses_anonymous_args = 0
  34              		@ link register save eliminated.
 109:./Hardware/as5047.c **** 	vel_estimate_valid_ = false;
  35              		.loc 1 109 2 view .LVU1
  36              		.loc 1 109 22 is_stmt 0 view .LVU2
  37 0000 0023     		movs	r3, #0
  38 0002 024A     		ldr	r2, .L2
  39 0004 1370     		strb	r3, [r2]
 110:./Hardware/as5047.c **** 	pos_estimate_valid_ = false;
  40              		.loc 1 110 2 is_stmt 1 view .LVU3
  41              		.loc 1 110 22 is_stmt 0 view .LVU4
  42 0006 024A     		ldr	r2, .L2+4
  43 0008 1370     		strb	r3, [r2]
 111:./Hardware/as5047.c **** 	// set_error(error);
 112:./Hardware/as5047.c **** }
  44              		.loc 1 112 1 view .LVU5
  45 000a 7047     		bx	lr
  46              	.L3:
  47              		.align	2
  48              	.L2:
  49 000c 00000000 		.word	.LANCHOR0
  50 0010 00000000 		.word	.LANCHOR1
  51              		.cfi_endproc
  52              	.LFE239:
  54              		.section	.text.update_pll_gains,"ax",%progbits
  55              		.align	1
  56              		.global	update_pll_gains
  57              		.syntax unified
  58              		.thumb
  59              		.thumb_func
  61              	update_pll_gains:
  62              	.LFB240:
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 4


 113:./Hardware/as5047.c **** /*****************************************************************************/
 114:./Hardware/as5047.c **** void update_pll_gains(void)
 115:./Hardware/as5047.c **** {
  63              		.loc 1 115 1 is_stmt 1 view -0
  64              		.cfi_startproc
  65              		@ args = 0, pretend = 0, frame = 0
  66              		@ frame_needed = 0, uses_anonymous_args = 0
  67              		@ link register save eliminated.
 116:./Hardware/as5047.c **** 	pll_kp_ = 2.0f * encoder_config.bandwidth;  // basic conversion to discrete time
  68              		.loc 1 116 2 view .LVU7
  69              		.loc 1 116 33 is_stmt 0 view .LVU8
  70 0000 084B     		ldr	r3, .L5
  71 0002 D3ED047A 		vldr.32	s15, [r3, #16]
  72              		.loc 1 116 17 view .LVU9
  73 0006 77EEA77A 		vadd.f32	s15, s15, s15
  74              		.loc 1 116 10 view .LVU10
  75 000a 074B     		ldr	r3, .L5+4
  76 000c C3ED007A 		vstr.32	s15, [r3]
 117:./Hardware/as5047.c **** 	pll_ki_ = 0.25f * (pll_kp_ * pll_kp_); // Critically damped
  77              		.loc 1 117 2 is_stmt 1 view .LVU11
  78              		.loc 1 117 29 is_stmt 0 view .LVU12
  79 0010 67EEA77A 		vmul.f32	s15, s15, s15
  80              		.loc 1 117 18 view .LVU13
  81 0014 B5EE007A 		vmov.f32	s14, #2.5e-1
  82 0018 67EE877A 		vmul.f32	s15, s15, s14
  83              		.loc 1 117 10 view .LVU14
  84 001c 034B     		ldr	r3, .L5+8
  85 001e C3ED007A 		vstr.32	s15, [r3]
 118:./Hardware/as5047.c **** 	// Check that we don't get problems with discrete time approximation
 119:./Hardware/as5047.c **** 	// if (!(current_meas_period * pll_kp_ < 1.0f))
 120:./Hardware/as5047.c **** 		// encoder_set_error(ERROR_UNSTABLE_GAIN);
 121:./Hardware/as5047.c **** }
  86              		.loc 1 121 1 view .LVU15
  87 0022 7047     		bx	lr
  88              	.L6:
  89              		.align	2
  90              	.L5:
  91 0024 00000000 		.word	.LANCHOR2
  92 0028 00000000 		.word	.LANCHOR3
  93 002c 00000000 		.word	.LANCHOR4
  94              		.cfi_endproc
  95              	.LFE240:
  97              		.section	.text.run_offset_calibration,"ax",%progbits
  98              		.align	1
  99              		.global	run_offset_calibration
 100              		.syntax unified
 101              		.thumb
 102              		.thumb_func
 104              	run_offset_calibration:
 105              	.LFB241:
 122:./Hardware/as5047.c **** /*****************************************************************************/
 123:./Hardware/as5047.c **** 
 124:./Hardware/as5047.c **** /*****************************************************************************/
 125:./Hardware/as5047.c **** /*****************************************************************************/
 126:./Hardware/as5047.c **** // @brief Turns the motor in one direction for a bit and then in the other
 127:./Hardware/as5047.c **** // direction in order to find the offset between the electrical phase 0
 128:./Hardware/as5047.c **** // and the encoder state 0.
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 5


 129:./Hardware/as5047.c **** bool run_offset_calibration(void)
 130:./Hardware/as5047.c **** {
 106              		.loc 1 130 1 is_stmt 1 view -0
 107              		.cfi_startproc
 108              		@ args = 0, pretend = 0, frame = 0
 109              		@ frame_needed = 0, uses_anonymous_args = 0
 110              		@ link register save eliminated.
 131:./Hardware/as5047.c **** 	uint32_t  i;
 111              		.loc 1 131 2 view .LVU17
 132:./Hardware/as5047.c **** 	const float start_lock_duration = 1.0f;	
 112              		.loc 1 132 2 view .LVU18
 113              	.LVL1:
 133:./Hardware/as5047.c **** 	encoder_config.direction = 1;
 114              		.loc 1 133 2 view .LVU19
 115              		.loc 1 133 27 is_stmt 0 view .LVU20
 116 0000 044B     		ldr	r3, .L8
 117 0002 0120     		movs	r0, #1
 118 0004 9862     		str	r0, [r3, #40]
 134:./Hardware/as5047.c **** 	encoder_config.phase_offset = 23406;
 119              		.loc 1 134 2 is_stmt 1 view .LVU21
 120              		.loc 1 134 30 is_stmt 0 view .LVU22
 121 0006 45F66E32 		movw	r2, #23406
 122 000a 5A61     		str	r2, [r3, #20]
 135:./Hardware/as5047.c **** 	encoder_config.phase_offset_float = 0.56f;
 123              		.loc 1 135 2 is_stmt 1 view .LVU23
 124              		.loc 1 135 36 is_stmt 0 view .LVU24
 125 000c 024A     		ldr	r2, .L8+4
 126 000e 9A61     		str	r2, [r3, #24]	@ float
 136:./Hardware/as5047.c **** 	return true;
 127              		.loc 1 136 2 is_stmt 1 view .LVU25
 137:./Hardware/as5047.c **** }
 128              		.loc 1 137 1 is_stmt 0 view .LVU26
 129 0010 7047     		bx	lr
 130              	.L9:
 131 0012 00BF     		.align	2
 132              	.L8:
 133 0014 00000000 		.word	.LANCHOR2
 134 0018 295C0F3F 		.word	1057971241
 135              		.cfi_endproc
 136              	.LFE241:
 138              		.section	.text.MagneticSensor_Init,"ax",%progbits
 139              		.align	1
 140              		.global	MagneticSensor_Init
 141              		.syntax unified
 142              		.thumb
 143              		.thumb_func
 145              	MagneticSensor_Init:
 146              	.LFB242:
 138:./Hardware/as5047.c **** //åˆå§‹åŒ–ä¸‰ç§SPIæ¥å£çš„ç¼–ç å™¨çš„å‚æ•°, åˆå§‹åŒ–I2Cæ¥å£æˆ–è€…SPIæ¥å£
 139:./Hardware/as5047.c **** void MagneticSensor_Init(void)
 140:./Hardware/as5047.c **** {
 147              		.loc 1 140 1 is_stmt 1 view -0
 148              		.cfi_startproc
 149              		@ args = 0, pretend = 0, frame = 0
 150              		@ frame_needed = 0, uses_anonymous_args = 0
 151 0000 08B5     		push	{r3, lr}
 152              	.LCFI0:
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 6


 153              		.cfi_def_cfa_offset 8
 154              		.cfi_offset 3, -8
 155              		.cfi_offset 14, -4
 141:./Hardware/as5047.c **** 	//è¯»å–flashå†…ä¿å­˜çš„å‚æ•°
 142:./Hardware/as5047.c **** 	encoder_config.mode = ENCODER_mode;  //é€‰æ‹©ç¼–ç å™¨å‹å·ï¼Œå‚æ•°è®¾ç½®å®å®šä¹‰åœ¨MyProject.h
 156              		.loc 1 142 2 view .LVU28
 157              		.loc 1 142 22 is_stmt 0 view .LVU29
 158 0002 114B     		ldr	r3, .L12
 159 0004 0121     		movs	r1, #1
 160 0006 1970     		strb	r1, [r3]
 143:./Hardware/as5047.c **** 	encoder_config.cpr = ENCODER_cpr;    //ç¼–ç å™¨cpr
 161              		.loc 1 143 2 is_stmt 1 view .LVU30
 162              		.loc 1 143 21 is_stmt 0 view .LVU31
 163 0008 4FF48042 		mov	r2, #16384
 164 000c DA61     		str	r2, [r3, #28]
 144:./Hardware/as5047.c **** 	encoder_config.bandwidth = ENCODER_bandwidth;   //ç¼–ç å™¨å¸¦å®½
 165              		.loc 1 144 2 is_stmt 1 view .LVU32
 166              		.loc 1 144 27 is_stmt 0 view .LVU33
 167 000e 0F4A     		ldr	r2, .L12+4
 168 0010 1A61     		str	r2, [r3, #16]	@ float
 145:./Hardware/as5047.c **** 	encoder_config.calib_range = 0.02f; // Accuracy required to pass encoder cpr check  2%è¯¯å·®
 169              		.loc 1 145 2 is_stmt 1 view .LVU34
 170              		.loc 1 145 29 is_stmt 0 view .LVU35
 171 0012 0F4A     		ldr	r2, .L12+8
 172 0014 5A60     		str	r2, [r3, #4]	@ float
 146:./Hardware/as5047.c **** 	encoder_config.calib_scan_distance = 16.0f * M_PI; // rad electrical    æ ¡å‡†çš„æ—¶å€™æ­£åè½¬8ä
 173              		.loc 1 146 2 is_stmt 1 view .LVU36
 174              		.loc 1 146 37 is_stmt 0 view .LVU37
 175 0016 0F4A     		ldr	r2, .L12+12
 176 0018 9A60     		str	r2, [r3, #8]	@ float
 147:./Hardware/as5047.c **** 	encoder_config.calib_scan_omega = 4.0f * M_PI;     // rad/s electrical  è½¬é€Ÿ2ä¸ªæå¯¹æ•°/ç§’ï¼Œ
 177              		.loc 1 147 2 is_stmt 1 view .LVU38
 178              		.loc 1 147 34 is_stmt 0 view .LVU39
 179 001a 0F4A     		ldr	r2, .L12+16
 180 001c DA60     		str	r2, [r3, #12]	@ float
 148:./Hardware/as5047.c **** 	encoder_config.phase_offset = 0;        // Offset between encoder count and rotor electrical phase
 181              		.loc 1 148 2 is_stmt 1 view .LVU40
 182              		.loc 1 148 30 is_stmt 0 view .LVU41
 183 001e 0022     		movs	r2, #0
 184 0020 5A61     		str	r2, [r3, #20]
 149:./Hardware/as5047.c **** 	encoder_config.phase_offset_float = 0.0f; // Sub-count phase alignment offset
 185              		.loc 1 149 2 is_stmt 1 view .LVU42
 186              		.loc 1 149 36 is_stmt 0 view .LVU43
 187 0022 0020     		movs	r0, #0
 188 0024 9861     		str	r0, [r3, #24]	@ float
 150:./Hardware/as5047.c **** 	encoder_config.index_offset = 0.0f;
 189              		.loc 1 150 2 is_stmt 1 view .LVU44
 190              		.loc 1 150 30 is_stmt 0 view .LVU45
 191 0026 1862     		str	r0, [r3, #32]	@ float
 151:./Hardware/as5047.c **** 	encoder_config.use_index = false;
 192              		.loc 1 151 2 is_stmt 1 view .LVU46
 193              		.loc 1 151 27 is_stmt 0 view .LVU47
 194 0028 83F82420 		strb	r2, [r3, #36]
 152:./Hardware/as5047.c **** 	encoder_config.pre_calibrated = false;
 195              		.loc 1 152 2 is_stmt 1 view .LVU48
 196              		.loc 1 152 32 is_stmt 0 view .LVU49
 197 002c 83F82520 		strb	r2, [r3, #37]
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 7


 153:./Hardware/as5047.c **** 	encoder_config.direction = 0; // direction with respect to motor
 198              		.loc 1 153 2 is_stmt 1 view .LVU50
 199              		.loc 1 153 27 is_stmt 0 view .LVU51
 200 0030 9A62     		str	r2, [r3, #40]
 154:./Hardware/as5047.c **** 	encoder_config.use_index_offset = true;
 201              		.loc 1 154 2 is_stmt 1 view .LVU52
 202              		.loc 1 154 34 is_stmt 0 view .LVU53
 203 0032 83F82C10 		strb	r1, [r3, #44]
 155:./Hardware/as5047.c **** 	encoder_config.enable_phase_interpolation = true; // Use velocity to interpolate inside the count 
 204              		.loc 1 155 2 is_stmt 1 view .LVU54
 205              		.loc 1 155 44 is_stmt 0 view .LVU55
 206 0036 83F82D10 		strb	r1, [r3, #45]
 156:./Hardware/as5047.c **** 	encoder_config.find_idx_on_lockin_only = false; // Only be sensitive during lockin scan constant v
 207              		.loc 1 156 2 is_stmt 1 view .LVU56
 208              		.loc 1 156 41 is_stmt 0 view .LVU57
 209 003a 83F82E20 		strb	r2, [r3, #46]
 157:./Hardware/as5047.c **** 	
 158:./Hardware/as5047.c **** 	update_pll_gains();    //é”ç›¸ç¯å‚æ•°æ•´å®š
 210              		.loc 1 158 2 is_stmt 1 view .LVU58
 211 003e FFF7FEFF 		bl	update_pll_gains
 212              	.LVL2:
 159:./Hardware/as5047.c **** 	run_offset_calibration();
 213              		.loc 1 159 2 view .LVU59
 214 0042 FFF7FEFF 		bl	run_offset_calibration
 215              	.LVL3:
 160:./Hardware/as5047.c ****     // SPI3_Init_(SPI_CPOL_Low);    //AS5047P
 161:./Hardware/as5047.c **** 
 162:./Hardware/as5047.c **** }
 216              		.loc 1 162 1 is_stmt 0 view .LVU60
 217 0046 08BD     		pop	{r3, pc}
 218              	.L13:
 219              		.align	2
 220              	.L12:
 221 0048 00000000 		.word	.LANCHOR2
 222 004c 00007A44 		.word	1148846080
 223 0050 0AD7A33C 		.word	1017370378
 224 0054 DB0F4942 		.word	1112084443
 225 0058 DB0F4941 		.word	1095307227
 226              		.cfi_endproc
 227              	.LFE242:
 229              		.section	.text.encoder_update,"ax",%progbits
 230              		.align	1
 231              		.global	encoder_update
 232              		.syntax unified
 233              		.thumb
 234              		.thumb_func
 236              	encoder_update:
 237              	.LVL4:
 238              	.LFB243:
 163:./Hardware/as5047.c **** 
 164:./Hardware/as5047.c **** 
 165:./Hardware/as5047.c **** /****************************************************************************/
 166:./Hardware/as5047.c **** bool encoder_update(int32_t raw)
 167:./Hardware/as5047.c **** {
 239              		.loc 1 167 1 is_stmt 1 view -0
 240              		.cfi_startproc
 241              		@ args = 0, pretend = 0, frame = 0
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 8


 242              		@ frame_needed = 0, uses_anonymous_args = 0
 243              		.loc 1 167 1 is_stmt 0 view .LVU62
 244 0000 F8B5     		push	{r3, r4, r5, r6, r7, lr}
 245              	.LCFI1:
 246              		.cfi_def_cfa_offset 24
 247              		.cfi_offset 3, -24
 248              		.cfi_offset 4, -20
 249              		.cfi_offset 5, -16
 250              		.cfi_offset 6, -12
 251              		.cfi_offset 7, -8
 252              		.cfi_offset 14, -4
 253 0002 2DED088B 		vpush.64	{d8, d9, d10, d11}
 254              	.LCFI2:
 255              		.cfi_def_cfa_offset 56
 256              		.cfi_offset 80, -56
 257              		.cfi_offset 81, -52
 258              		.cfi_offset 82, -48
 259              		.cfi_offset 83, -44
 260              		.cfi_offset 84, -40
 261              		.cfi_offset 85, -36
 262              		.cfi_offset 86, -32
 263              		.cfi_offset 87, -28
 264 0006 0446     		mov	r4, r0
 168:./Hardware/as5047.c **** 	int32_t delta_enc = 0;
 265              		.loc 1 168 2 is_stmt 1 view .LVU63
 266              	.LVL5:
 169:./Hardware/as5047.c **** 	int32_t pos_abs_latched; //LATCH
 267              		.loc 1 169 2 view .LVU64
 170:./Hardware/as5047.c **** 	static int32_t shadow_count_ = 0;   //ç¼–ç å™¨ç´¯è®¡è®¡æ•°ã€‚
 268              		.loc 1 170 2 view .LVU65
 171:./Hardware/as5047.c **** 	 int32_t count_in_cpr_ = 0;   //ç¼–ç å™¨å½“å‰è®¡æ•°å€¼ã€‚
 269              		.loc 1 171 3 view .LVU66
 172:./Hardware/as5047.c **** 	 float interpolation_ = 0.0f; //ç¼–ç å™¨å½“å‰æ’è¡¥å€¼ã€‚
 270              		.loc 1 172 3 view .LVU67
 173:./Hardware/as5047.c **** 	static float pos_estimate_counts_ = 0.0f;  //å½“å‰ä¼°ç®—çš„ä½ç½®å€¼ï¼Œå•ä½[count]   
 271              		.loc 1 173 2 view .LVU68
 174:./Hardware/as5047.c **** 	static float pos_cpr_counts_ = 0.0f;       //å½“å‰çº¦æŸåœ¨cprèŒƒå›´å†…çš„ä½ç½®å€¼ï¼Œå•ä½[coun
 272              		.loc 1 174 2 view .LVU69
 175:./Hardware/as5047.c **** 	static float vel_estimate_counts_ = 0.0f;  //å½“å‰ä¼°ç®—è½¬é€Ÿï¼Œå•ä½[count/s]
 273              		.loc 1 175 2 view .LVU70
 176:./Hardware/as5047.c **** 
 177:./Hardware/as5047.c **** 	pos_abs_latched = raw;
 274              		.loc 1 177 2 view .LVU71
 178:./Hardware/as5047.c **** 
 179:./Hardware/as5047.c **** 	delta_enc = pos_abs_latched - count_in_cpr_; //LATCH
 275              		.loc 1 179 2 view .LVU72
 180:./Hardware/as5047.c **** 	delta_enc = mod(delta_enc, encoder_config.cpr);
 276              		.loc 1 180 2 view .LVU73
 277              		.loc 1 180 43 is_stmt 0 view .LVU74
 278 0008 7D4B     		ldr	r3, .L37
 279 000a DA69     		ldr	r2, [r3, #28]
 280              	.LVL6:
 281              	.LBB25:
 282              	.LBI25:
  99:./Hardware/as5047.c **** {
 283              		.loc 1 99 19 is_stmt 1 view .LVU75
 284              	.LBB26:
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 9


 101:./Hardware/as5047.c **** 	if (r < 0) r += divisor;
 285              		.loc 1 101 2 view .LVU76
 101:./Hardware/as5047.c **** 	if (r < 0) r += divisor;
 286              		.loc 1 101 6 is_stmt 0 view .LVU77
 287 000c 90FBF2F5 		sdiv	r5, r0, r2
 288 0010 02FB1505 		mls	r5, r2, r5, r0
 289              	.LVL7:
 102:./Hardware/as5047.c **** 	return r;
 290              		.loc 1 102 2 is_stmt 1 view .LVU78
 102:./Hardware/as5047.c **** 	return r;
 291              		.loc 1 102 5 is_stmt 0 view .LVU79
 292 0014 002D     		cmp	r5, #0
 293 0016 7ADB     		blt	.L34
 294              	.L15:
 103:./Hardware/as5047.c **** }
 295              		.loc 1 103 2 is_stmt 1 view .LVU80
 296              	.LVL8:
 103:./Hardware/as5047.c **** }
 297              		.loc 1 103 2 is_stmt 0 view .LVU81
 298              	.LBE26:
 299              	.LBE25:
 181:./Hardware/as5047.c **** 	if(delta_enc > encoder_config.cpr/2)
 300              		.loc 1 181 2 is_stmt 1 view .LVU82
 301              		.loc 1 181 35 is_stmt 0 view .LVU83
 302 0018 02EBD273 		add	r3, r2, r2, lsr #31
 303              		.loc 1 181 4 view .LVU84
 304 001c B5EB630F 		cmp	r5, r3, asr #1
 305 0020 00DD     		ble	.L16
 182:./Hardware/as5047.c **** 	delta_enc -= encoder_config.cpr;
 306              		.loc 1 182 2 is_stmt 1 view .LVU85
 307              		.loc 1 182 12 is_stmt 0 view .LVU86
 308 0022 AD1A     		subs	r5, r5, r2
 309              	.LVL9:
 310              	.L16:
 183:./Hardware/as5047.c **** 	shadow_count_ += delta_enc;
 311              		.loc 1 183 2 is_stmt 1 view .LVU87
 312              		.loc 1 183 16 is_stmt 0 view .LVU88
 313 0024 7749     		ldr	r1, .L37+4
 314 0026 0B68     		ldr	r3, [r1]
 315 0028 2B44     		add	r3, r3, r5
 316 002a 0B60     		str	r3, [r1]
 184:./Hardware/as5047.c **** 	count_in_cpr_ = pos_abs_latched;
 317              		.loc 1 184 2 is_stmt 1 view .LVU89
 318              	.LVL10:
 185:./Hardware/as5047.c **** 	
 186:./Hardware/as5047.c **** 	// Memory for pos_circular
 187:./Hardware/as5047.c **** 	float pos_cpr_counts_last = pos_cpr_counts_;
 319              		.loc 1 187 2 view .LVU90
 320              		.loc 1 187 8 is_stmt 0 view .LVU91
 321 002c 764E     		ldr	r6, .L37+8
 322 002e D6ED007A 		vldr.32	s15, [r6]
 323              	.LVL11:
 188:./Hardware/as5047.c **** 	
 189:./Hardware/as5047.c **** 	// run pll (for now pll is in units of encoder counts)
 190:./Hardware/as5047.c **** 	// Predict current pos
 191:./Hardware/as5047.c **** 	pos_estimate_counts_ += current_meas_period * vel_estimate_counts_;
 324              		.loc 1 191 2 is_stmt 1 view .LVU92
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 10


 325              		.loc 1 191 46 is_stmt 0 view .LVU93
 326 0032 7649     		ldr	r1, .L37+12
 327 0034 D1ED00AA 		vldr.32	s21, [r1]
 328 0038 DFED75BA 		vldr.32	s23, .L37+16
 329 003c 2AEEAB8A 		vmul.f32	s16, s21, s23
 330              		.loc 1 191 23 view .LVU94
 331 0040 744F     		ldr	r7, .L37+20
 332 0042 97ED00BA 		vldr.32	s22, [r7]
 333 0046 38EE0BBA 		vadd.f32	s22, s16, s22
 334 004a 87ED00BA 		vstr.32	s22, [r7]
 192:./Hardware/as5047.c **** 	pos_cpr_counts_      += current_meas_period * vel_estimate_counts_;
 335              		.loc 1 192 2 is_stmt 1 view .LVU95
 336              		.loc 1 192 23 is_stmt 0 view .LVU96
 337 004e 38EE278A 		vadd.f32	s16, s16, s15
 338 0052 86ED008A 		vstr.32	s16, [r6]
 193:./Hardware/as5047.c **** 	
 194:./Hardware/as5047.c **** 	// discrete phase detector
 195:./Hardware/as5047.c **** 	float delta_pos_counts = (float)(shadow_count_ - (int32_t)pos_estimate_counts_);
 339              		.loc 1 195 2 is_stmt 1 view .LVU97
 340              		.loc 1 195 51 is_stmt 0 view .LVU98
 341 0056 BDEECB9A 		vcvt.s32.f32	s18, s22
 342              		.loc 1 195 49 view .LVU99
 343 005a 19EE101A 		vmov	r1, s18	@ int
 344 005e 5B1A     		subs	r3, r3, r1
 345              		.loc 1 195 8 view .LVU100
 346 0060 07EE903A 		vmov	s15, r3	@ int
 347              	.LVL12:
 348              		.loc 1 195 8 view .LVU101
 349 0064 B8EEE79A 		vcvt.f32.s32	s18, s15
 350              	.LVL13:
 196:./Hardware/as5047.c **** 	float delta_pos_cpr_counts = (float)(count_in_cpr_ - (int32_t)pos_cpr_counts_);
 351              		.loc 1 196 2 is_stmt 1 view .LVU102
 352              		.loc 1 196 55 is_stmt 0 view .LVU103
 353 0068 FDEEC89A 		vcvt.s32.f32	s19, s16
 354              		.loc 1 196 53 view .LVU104
 355 006c 19EE903A 		vmov	r3, s19	@ int
 356 0070 E31A     		subs	r3, r4, r3
 357 0072 09EE903A 		vmov	s19, r3	@ int
 358              		.loc 1 196 8 view .LVU105
 359 0076 B8EEE9AA 		vcvt.f32.s32	s20, s19
 360              	.LVL14:
 197:./Hardware/as5047.c **** 	delta_pos_cpr_counts = wrap_pm(delta_pos_cpr_counts, (float)(encoder_config.cpr));
 361              		.loc 1 197 2 is_stmt 1 view .LVU106
 362              		.loc 1 197 25 is_stmt 0 view .LVU107
 363 007a 07EE902A 		vmov	s15, r2	@ int
 364 007e F8EEE78A 		vcvt.f32.s32	s17, s15
 365              	.LVL15:
 366              	.LBB28:
 367              	.LBI28:
  80:./Hardware/as5047.c **** #ifdef FPU_FPV4
 368              		.loc 1 80 21 is_stmt 1 view .LVU108
 369              	.LBB29:
  84:./Hardware/as5047.c **** #endif
 370              		.loc 1 84 2 view .LVU109
  84:./Hardware/as5047.c **** #endif
 371              		.loc 1 84 17 is_stmt 0 view .LVU110
 372 0082 8AEE280A 		vdiv.f32	s0, s20, s17
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 11


 373 0086 FFF7FEFF 		bl	nearbyintf
 374              	.LVL16:
  86:./Hardware/as5047.c **** }
 375              		.loc 1 86 2 is_stmt 1 view .LVU111
  86:./Hardware/as5047.c **** }
 376              		.loc 1 86 20 is_stmt 0 view .LVU112
 377 008a 68EE809A 		vmul.f32	s19, s17, s0
  86:./Hardware/as5047.c **** }
 378              		.loc 1 86 11 view .LVU113
 379 008e 7AEE699A 		vsub.f32	s19, s20, s19
 380              	.LVL17:
  86:./Hardware/as5047.c **** }
 381              		.loc 1 86 11 view .LVU114
 382              	.LBE29:
 383              	.LBE28:
 198:./Hardware/as5047.c **** 	// pll feedback
 199:./Hardware/as5047.c **** 	pos_estimate_counts_ += current_meas_period * pll_kp_ * delta_pos_counts;
 384              		.loc 1 199 2 is_stmt 1 view .LVU115
 385              		.loc 1 199 46 is_stmt 0 view .LVU116
 386 0092 614B     		ldr	r3, .L37+24
 387 0094 D3ED007A 		vldr.32	s15, [r3]
 388 0098 67EEAB7A 		vmul.f32	s15, s15, s23
 389              		.loc 1 199 56 view .LVU117
 390 009c 27EE899A 		vmul.f32	s18, s15, s18
 391              	.LVL18:
 392              		.loc 1 199 23 view .LVU118
 393 00a0 3BEE099A 		vadd.f32	s18, s22, s18
 394 00a4 87ED009A 		vstr.32	s18, [r7]
 200:./Hardware/as5047.c **** 	pos_cpr_counts_ += current_meas_period * pll_kp_ * delta_pos_cpr_counts;
 395              		.loc 1 200 2 is_stmt 1 view .LVU119
 396              		.loc 1 200 51 is_stmt 0 view .LVU120
 397 00a8 67EEA97A 		vmul.f32	s15, s15, s19
 398              		.loc 1 200 18 view .LVU121
 399 00ac 38EE278A 		vadd.f32	s16, s16, s15
 400 00b0 86ED008A 		vstr.32	s16, [r6]
 201:./Hardware/as5047.c **** 	pos_cpr_counts_ = fmodf_pos(pos_cpr_counts_, (float)(encoder_config.cpr));
 401              		.loc 1 201 2 is_stmt 1 view .LVU122
 402              	.LVL19:
 403              	.LBB30:
 404              	.LBI30:
  88:./Hardware/as5047.c **** 	float res = wrap_pm(x, y);
 405              		.loc 1 88 21 view .LVU123
 406              	.LBB31:
  89:./Hardware/as5047.c **** 	if (res < 0) res += y;
 407              		.loc 1 89 2 view .LVU124
 408              	.LBB32:
 409              	.LBI32:
  80:./Hardware/as5047.c **** #ifdef FPU_FPV4
 410              		.loc 1 80 21 view .LVU125
 411              	.LBB33:
  84:./Hardware/as5047.c **** #endif
 412              		.loc 1 84 2 view .LVU126
  84:./Hardware/as5047.c **** #endif
 413              		.loc 1 84 17 is_stmt 0 view .LVU127
 414 00b4 88EE280A 		vdiv.f32	s0, s16, s17
 415 00b8 FFF7FEFF 		bl	nearbyintf
 416              	.LVL20:
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 12


  86:./Hardware/as5047.c **** }
 417              		.loc 1 86 2 is_stmt 1 view .LVU128
  86:./Hardware/as5047.c **** }
 418              		.loc 1 86 20 is_stmt 0 view .LVU129
 419 00bc 28EE800A 		vmul.f32	s0, s17, s0
 420              	.LVL21:
  86:./Hardware/as5047.c **** }
 421              		.loc 1 86 11 view .LVU130
 422 00c0 38EE408A 		vsub.f32	s16, s16, s0
 423              	.LVL22:
  86:./Hardware/as5047.c **** }
 424              		.loc 1 86 11 view .LVU131
 425              	.LBE33:
 426              	.LBE32:
  90:./Hardware/as5047.c **** 	return res;
 427              		.loc 1 90 2 is_stmt 1 view .LVU132
  90:./Hardware/as5047.c **** 	return res;
 428              		.loc 1 90 5 is_stmt 0 view .LVU133
 429 00c4 B5EEC08A 		vcmpe.f32	s16, #0
 430 00c8 F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 431 00cc 21D4     		bmi	.L35
 432              	.L17:
  91:./Hardware/as5047.c **** }
 433              		.loc 1 91 2 is_stmt 1 view .LVU134
 434              	.LVL23:
  91:./Hardware/as5047.c **** }
 435              		.loc 1 91 2 is_stmt 0 view .LVU135
 436              	.LBE31:
 437              	.LBE30:
 438              		.loc 1 201 18 view .LVU136
 439 00ce 4E4B     		ldr	r3, .L37+8
 440 00d0 83ED008A 		vstr.32	s16, [r3]
 202:./Hardware/as5047.c **** 	vel_estimate_counts_ += current_meas_period * pll_ki_ * delta_pos_cpr_counts;
 441              		.loc 1 202 2 is_stmt 1 view .LVU137
 442              		.loc 1 202 46 is_stmt 0 view .LVU138
 443 00d4 514B     		ldr	r3, .L37+28
 444 00d6 D3ED007A 		vldr.32	s15, [r3]
 445 00da 9FED4D0A 		vldr.32	s0, .L37+16
 446 00de 27EE800A 		vmul.f32	s0, s15, s0
 447              		.loc 1 202 56 view .LVU139
 448 00e2 60EE299A 		vmul.f32	s19, s0, s19
 449              	.LVL24:
 450              		.loc 1 202 23 view .LVU140
 451 00e6 7AEEA99A 		vadd.f32	s19, s21, s19
 452 00ea 484B     		ldr	r3, .L37+12
 453 00ec C3ED009A 		vstr.32	s19, [r3]
 203:./Hardware/as5047.c **** 	uint8_t snap_to_zero_vel = false;
 454              		.loc 1 203 2 is_stmt 1 view .LVU141
 455              	.LVL25:
 204:./Hardware/as5047.c **** 	if (fabsf(vel_estimate_counts_) < 0.5f * current_meas_period * pll_ki_)
 456              		.loc 1 204 2 view .LVU142
 457              		.loc 1 204 6 is_stmt 0 view .LVU143
 458 00f0 F0EEE99A 		vabs.f32	s19, s19
 459              		.loc 1 204 63 view .LVU144
 460 00f4 9FED4A7A 		vldr.32	s14, .L37+32
 461 00f8 67EE877A 		vmul.f32	s15, s15, s14
 462              		.loc 1 204 5 view .LVU145
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 13


 463 00fc F4EEE79A 		vcmpe.f32	s19, s15
 464 0100 F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 465 0104 08D5     		bpl	.L32
 205:./Hardware/as5047.c **** 	{
 206:./Hardware/as5047.c **** 		vel_estimate_counts_ = 0.0f;  //align delta-sigma on zero to prevent jitter
 466              		.loc 1 206 3 is_stmt 1 view .LVU146
 467              		.loc 1 206 24 is_stmt 0 view .LVU147
 468 0106 0022     		movs	r2, #0
 469 0108 1A60     		str	r2, [r3]	@ float
 207:./Hardware/as5047.c **** 		snap_to_zero_vel = true;
 470              		.loc 1 207 3 is_stmt 1 view .LVU148
 471              	.LVL26:
 472              		.loc 1 207 20 is_stmt 0 view .LVU149
 473 010a 0123     		movs	r3, #1
 474 010c 05E0     		b	.L19
 475              	.LVL27:
 476              	.L34:
 477              	.LBB35:
 478              	.LBB27:
 102:./Hardware/as5047.c **** 	return r;
 479              		.loc 1 102 13 is_stmt 1 view .LVU150
 102:./Hardware/as5047.c **** 	return r;
 480              		.loc 1 102 15 is_stmt 0 view .LVU151
 481 010e 1544     		add	r5, r5, r2
 482              	.LVL28:
 102:./Hardware/as5047.c **** 	return r;
 483              		.loc 1 102 15 view .LVU152
 484 0110 82E7     		b	.L15
 485              	.LVL29:
 486              	.L35:
 102:./Hardware/as5047.c **** 	return r;
 487              		.loc 1 102 15 view .LVU153
 488              	.LBE27:
 489              	.LBE35:
 490              	.LBB36:
 491              	.LBB34:
  90:./Hardware/as5047.c **** 	return res;
 492              		.loc 1 90 15 is_stmt 1 view .LVU154
  90:./Hardware/as5047.c **** 	return res;
 493              		.loc 1 90 19 is_stmt 0 view .LVU155
 494 0112 38EE288A 		vadd.f32	s16, s16, s17
 495              	.LVL30:
  90:./Hardware/as5047.c **** 	return res;
 496              		.loc 1 90 19 view .LVU156
 497 0116 DAE7     		b	.L17
 498              	.LVL31:
 499              	.L32:
  90:./Hardware/as5047.c **** 	return res;
 500              		.loc 1 90 19 view .LVU157
 501              	.LBE34:
 502              	.LBE36:
 203:./Hardware/as5047.c **** 	if (fabsf(vel_estimate_counts_) < 0.5f * current_meas_period * pll_ki_)
 503              		.loc 1 203 10 view .LVU158
 504 0118 0023     		movs	r3, #0
 505              	.LVL32:
 506              	.L19:
 208:./Hardware/as5047.c **** 	}
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 14


 209:./Hardware/as5047.c **** 	
 210:./Hardware/as5047.c **** 	// Outputs from Encoder for Controller
 211:./Hardware/as5047.c **** 	pos_estimate_ = pos_estimate_counts_ / (float)encoder_config.cpr;
 507              		.loc 1 211 2 is_stmt 1 view .LVU159
 508              		.loc 1 211 39 is_stmt 0 view .LVU160
 509 011a C9EE287A 		vdiv.f32	s15, s18, s17
 510              		.loc 1 211 16 view .LVU161
 511 011e 414A     		ldr	r2, .L37+36
 512 0120 C2ED007A 		vstr.32	s15, [r2]
 212:./Hardware/as5047.c **** 	vel_estimate_ = vel_estimate_counts_ / (float)encoder_config.cpr;
 513              		.loc 1 212 2 is_stmt 1 view .LVU162
 514              		.loc 1 212 39 is_stmt 0 view .LVU163
 515 0124 394A     		ldr	r2, .L37+12
 516 0126 D2ED007A 		vldr.32	s15, [r2]
 517 012a 87EEA89A 		vdiv.f32	s18, s15, s17
 518              		.loc 1 212 16 view .LVU164
 519 012e 3E4A     		ldr	r2, .L37+40
 520 0130 82ED009A 		vstr.32	s18, [r2]
 213:./Hardware/as5047.c **** 
 214:./Hardware/as5047.c **** 	//// run encoder count interpolation
 215:./Hardware/as5047.c **** 	int32_t corrected_enc = count_in_cpr_ - encoder_config.phase_offset;
 521              		.loc 1 215 2 is_stmt 1 view .LVU165
 522              		.loc 1 215 56 is_stmt 0 view .LVU166
 523 0134 324A     		ldr	r2, .L37
 524 0136 5069     		ldr	r0, [r2, #20]
 525              		.loc 1 215 10 view .LVU167
 526 0138 221A     		subs	r2, r4, r0
 527 013a 08EE102A 		vmov	s16, r2	@ int
 528              	.LVL33:
 216:./Hardware/as5047.c **** 	// if we are stopped, make sure we don't randomly drift
 217:./Hardware/as5047.c **** 	if(snap_to_zero_vel || !encoder_config.enable_phase_interpolation)
 529              		.loc 1 217 2 is_stmt 1 view .LVU168
 530              		.loc 1 217 4 is_stmt 0 view .LVU169
 531 013e 1BBB     		cbnz	r3, .L24
 532              		.loc 1 217 40 discriminator 1 view .LVU170
 533 0140 2F4B     		ldr	r3, .L37
 534              	.LVL34:
 535              		.loc 1 217 40 discriminator 1 view .LVU171
 536 0142 93F82D30 		ldrb	r3, [r3, #45]	@ zero_extendqisi2
 537              		.loc 1 217 22 discriminator 1 view .LVU172
 538 0146 002B     		cmp	r3, #0
 539 0148 53D0     		beq	.L25
 218:./Hardware/as5047.c **** 	{
 219:./Hardware/as5047.c **** 		interpolation_ = 0.5f;
 220:./Hardware/as5047.c **** 		// reset interpolation if encoder edge comes
 221:./Hardware/as5047.c ****     // TODO: This isn't correct. At high velocities the first phase in this count may very well not
 222:./Hardware/as5047.c **** 	}
 223:./Hardware/as5047.c **** 	else if(delta_enc > 0){
 540              		.loc 1 223 7 is_stmt 1 view .LVU173
 541              		.loc 1 223 9 is_stmt 0 view .LVU174
 542 014a 002D     		cmp	r5, #0
 543 014c 02DD     		ble	.L36
 224:./Hardware/as5047.c **** 		interpolation_ = 0.0f;
 544              		.loc 1 224 18 view .LVU175
 545 014e DFED377A 		vldr.32	s15, .L37+44
 546 0152 1BE0     		b	.L21
 547              	.L36:
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 15


 225:./Hardware/as5047.c **** 	}else if(delta_enc < 0){
 548              		.loc 1 225 8 is_stmt 1 view .LVU176
 549              		.loc 1 225 10 is_stmt 0 view .LVU177
 550 0154 50DB     		blt	.L27
 226:./Hardware/as5047.c **** 		interpolation_ = 1.0f;
 227:./Hardware/as5047.c **** 	}
 228:./Hardware/as5047.c **** 	else {
 229:./Hardware/as5047.c **** 		// Interpolate (predict) between encoder counts using vel_estimate,
 230:./Hardware/as5047.c **** 		interpolation_ += current_meas_period * vel_estimate_counts_;
 551              		.loc 1 230 3 is_stmt 1 view .LVU178
 552              		.loc 1 230 41 is_stmt 0 view .LVU179
 553 0156 9FED2E7A 		vldr.32	s14, .L37+16
 554 015a 67EE877A 		vmul.f32	s15, s15, s14
 555              		.loc 1 230 18 view .LVU180
 556 015e 9FED337A 		vldr.32	s14, .L37+44
 557 0162 77EE877A 		vadd.f32	s15, s15, s14
 558              	.LVL35:
 231:./Hardware/as5047.c **** 		// don't allow interpolation indicated position outside of [enc, enc+1)
 232:./Hardware/as5047.c **** 		if (interpolation_ > 1.0f) interpolation_ = 1.0f;
 559              		.loc 1 232 3 is_stmt 1 view .LVU181
 560              		.loc 1 232 6 is_stmt 0 view .LVU182
 561 0166 B7EE007A 		vmov.f32	s14, #1.0e+0
 562 016a F4EEC77A 		vcmpe.f32	s15, s14
 563 016e F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 564 0172 01DD     		ble	.L22
 565              		.loc 1 232 45 view .LVU183
 566 0174 F0EE477A 		vmov.f32	s15, s14
 567              	.LVL36:
 568              	.L22:
 233:./Hardware/as5047.c **** 		if (interpolation_ < 0.0f) interpolation_ = 0.0f;
 569              		.loc 1 233 3 is_stmt 1 view .LVU184
 570              		.loc 1 233 6 is_stmt 0 view .LVU185
 571 0178 F5EEC07A 		vcmpe.f32	s15, #0
 572 017c F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 573 0180 04D5     		bpl	.L21
 574              		.loc 1 233 45 view .LVU186
 575 0182 DFED2A7A 		vldr.32	s15, .L37+44
 576              	.LVL37:
 577              		.loc 1 233 45 view .LVU187
 578 0186 01E0     		b	.L21
 579              	.LVL38:
 580              	.L24:
 219:./Hardware/as5047.c **** 		// reset interpolation if encoder edge comes
 581              		.loc 1 219 18 view .LVU188
 582 0188 F6EE007A 		vmov.f32	s15, #5.0e-1
 583              	.LVL39:
 584              	.L21:
 234:./Hardware/as5047.c **** 	}
 235:./Hardware/as5047.c **** 	float interpolated_enc = corrected_enc + interpolation_;
 585              		.loc 1 235 2 is_stmt 1 view .LVU189
 586              		.loc 1 235 41 is_stmt 0 view .LVU190
 587 018c B8EEC88A 		vcvt.f32.s32	s16, s16
 588              		.loc 1 235 8 view .LVU191
 589 0190 38EE278A 		vadd.f32	s16, s16, s15
 590              	.LVL40:
 236:./Hardware/as5047.c **** 	
 237:./Hardware/as5047.c **** 	//// compute electrical phase
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 16


 238:./Hardware/as5047.c **** 	//TODO avoid recomputing elec_rad_per_enc every time
 239:./Hardware/as5047.c **** 	float elec_rad_per_enc = MOTOR_pole_pairs  * 2 * M_PI * (1.0f / (float)(encoder_config.cpr));
 591              		.loc 1 239 2 is_stmt 1 view .LVU192
 592              		.loc 1 239 64 is_stmt 0 view .LVU193
 593 0194 B7EE007A 		vmov.f32	s14, #1.0e+0
 594 0198 C7EE287A 		vdiv.f32	s15, s14, s17
 595              	.LVL41:
 596              		.loc 1 239 8 view .LVU194
 597 019c 9FED247A 		vldr.32	s14, .L37+48
 598 01a0 67EE877A 		vmul.f32	s15, s15, s14
 599              	.LVL42:
 240:./Hardware/as5047.c **** 	float ph = elec_rad_per_enc * (interpolated_enc - encoder_config.phase_offset_float);
 600              		.loc 1 240 2 is_stmt 1 view .LVU195
 601              		.loc 1 240 66 is_stmt 0 view .LVU196
 602 01a4 164C     		ldr	r4, .L37
 603              	.LVL43:
 604              		.loc 1 240 66 view .LVU197
 605 01a6 94ED067A 		vldr.32	s14, [r4, #24]
 606              		.loc 1 240 50 view .LVU198
 607 01aa 38EE478A 		vsub.f32	s16, s16, s14
 608              	.LVL44:
 609              		.loc 1 240 8 view .LVU199
 610 01ae 28EE278A 		vmul.f32	s16, s16, s15
 611              	.LVL45:
 241:./Hardware/as5047.c **** 
 242:./Hardware/as5047.c **** 	encoder_config.phase_ = wrap_pm_pi(ph) * encoder_config.direction;
 612              		.loc 1 242 2 is_stmt 1 view .LVU200
 613              	.LBB37:
 614              	.LBI37:
  94:./Hardware/as5047.c **** 	return wrap_pm(x, 2 * M_PI);
 615              		.loc 1 94 21 view .LVU201
 616              	.LBE37:
  95:./Hardware/as5047.c **** }
 617              		.loc 1 95 2 view .LVU202
 618              	.LBB40:
 619              	.LBB38:
 620              	.LBI38:
  80:./Hardware/as5047.c **** #ifdef FPU_FPV4
 621              		.loc 1 80 21 view .LVU203
 622              	.LBB39:
  84:./Hardware/as5047.c **** #endif
 623              		.loc 1 84 2 view .LVU204
  84:./Hardware/as5047.c **** #endif
 624              		.loc 1 84 17 is_stmt 0 view .LVU205
 625 01b2 DFED208A 		vldr.32	s17, .L37+52
  84:./Hardware/as5047.c **** #endif
 626              		.loc 1 84 17 view .LVU206
 627 01b6 88EE280A 		vdiv.f32	s0, s16, s17
 628 01ba FFF7FEFF 		bl	nearbyintf
 629              	.LVL46:
  86:./Hardware/as5047.c **** }
 630              		.loc 1 86 2 is_stmt 1 view .LVU207
  86:./Hardware/as5047.c **** }
 631              		.loc 1 86 20 is_stmt 0 view .LVU208
 632 01be 20EE280A 		vmul.f32	s0, s0, s17
 633              	.LVL47:
  86:./Hardware/as5047.c **** }
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 17


 634              		.loc 1 86 11 view .LVU209
 635 01c2 38EE408A 		vsub.f32	s16, s16, s0
 636              	.LVL48:
  86:./Hardware/as5047.c **** }
 637              		.loc 1 86 11 view .LVU210
 638              	.LBE39:
 639              	.LBE38:
 640              	.LBE40:
 641              		.loc 1 242 41 view .LVU211
 642 01c6 D4ED0A7A 		vldr.32	s15, [r4, #40]	@ int
 643 01ca F8EEE77A 		vcvt.f32.s32	s15, s15
 644 01ce 27EE888A 		vmul.f32	s16, s15, s16
 645              		.loc 1 242 24 view .LVU212
 646 01d2 84ED0C8A 		vstr.32	s16, [r4, #48]
 243:./Hardware/as5047.c **** 	encoder_config.phase_vel_ = (2*M_PI) * vel_estimate_ * MOTOR_pole_pairs  * encoder_config.directio
 647              		.loc 1 243 2 is_stmt 1 view .LVU213
 648              		.loc 1 243 39 is_stmt 0 view .LVU214
 649 01d6 29EE287A 		vmul.f32	s14, s18, s17
 650              		.loc 1 243 55 view .LVU215
 651 01da F1EE0C6A 		vmov.f32	s13, #7.0e+0
 652 01de 27EE267A 		vmul.f32	s14, s14, s13
 653              		.loc 1 243 75 view .LVU216
 654 01e2 67EE877A 		vmul.f32	s15, s15, s14
 655              		.loc 1 243 28 view .LVU217
 656 01e6 C4ED0D7A 		vstr.32	s15, [r4, #52]
 244:./Hardware/as5047.c **** 
 245:./Hardware/as5047.c **** 	return 1;
 657              		.loc 1 245 2 is_stmt 1 view .LVU218
 246:./Hardware/as5047.c **** }
 658              		.loc 1 246 1 is_stmt 0 view .LVU219
 659 01ea 0120     		movs	r0, #1
 660 01ec BDEC088B 		vldm	sp!, {d8-d11}
 661              	.LCFI3:
 662              		.cfi_remember_state
 663              		.cfi_restore 86
 664              		.cfi_restore 87
 665              		.cfi_restore 84
 666              		.cfi_restore 85
 667              		.cfi_restore 82
 668              		.cfi_restore 83
 669              		.cfi_restore 80
 670              		.cfi_restore 81
 671              		.cfi_def_cfa_offset 24
 672              		.loc 1 246 1 view .LVU220
 673 01f0 F8BD     		pop	{r3, r4, r5, r6, r7, pc}
 674              	.LVL49:
 675              	.L25:
 676              	.LCFI4:
 677              		.cfi_restore_state
 219:./Hardware/as5047.c **** 		// reset interpolation if encoder edge comes
 678              		.loc 1 219 18 view .LVU221
 679 01f2 F6EE007A 		vmov.f32	s15, #5.0e-1
 680 01f6 C9E7     		b	.L21
 681              	.L27:
 226:./Hardware/as5047.c **** 	}
 682              		.loc 1 226 18 view .LVU222
 683 01f8 F7EE007A 		vmov.f32	s15, #1.0e+0
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 18


 684 01fc C6E7     		b	.L21
 685              	.L38:
 686 01fe 00BF     		.align	2
 687              	.L37:
 688 0200 00000000 		.word	.LANCHOR2
 689 0204 00000000 		.word	.LANCHOR5
 690 0208 00000000 		.word	.LANCHOR6
 691 020c 00000000 		.word	.LANCHOR7
 692 0210 6F120339 		.word	956502639
 693 0214 00000000 		.word	.LANCHOR8
 694 0218 00000000 		.word	.LANCHOR3
 695 021c 00000000 		.word	.LANCHOR4
 696 0220 6F128338 		.word	948114031
 697 0224 00000000 		.word	.LANCHOR9
 698 0228 00000000 		.word	.LANCHOR10
 699 022c 00000000 		.word	0
 700 0230 E0ED2F42 		.word	1110437344
 701 0234 DB0FC940 		.word	1086918619
 702              		.cfi_endproc
 703              	.LFE243:
 705              		.section	.text.Parity_bit_Calculate,"ax",%progbits
 706              		.align	1
 707              		.global	Parity_bit_Calculate
 708              		.syntax unified
 709              		.thumb
 710              		.thumb_func
 712              	Parity_bit_Calculate:
 713              	.LVL50:
 714              	.LFB244:
 247:./Hardware/as5047.c **** /****************************************************************************/
 248:./Hardware/as5047.c **** 
 249:./Hardware/as5047.c **** 
 250:./Hardware/as5047.c **** 
 251:./Hardware/as5047.c **** 
 252:./Hardware/as5047.c **** 
 253:./Hardware/as5047.c **** 
 254:./Hardware/as5047.c **** 
 255:./Hardware/as5047.c **** //è®¡ç®—å¥‡å¶å‡½æ•°
 256:./Hardware/as5047.c **** uint16_t Parity_bit_Calculate(uint16_t data_2_cal)
 257:./Hardware/as5047.c **** {
 715              		.loc 1 257 1 is_stmt 1 view -0
 716              		.cfi_startproc
 717              		@ args = 0, pretend = 0, frame = 0
 718              		@ frame_needed = 0, uses_anonymous_args = 0
 719              		@ link register save eliminated.
 258:./Hardware/as5047.c **** 	uint16_t parity_bit_value=0;
 720              		.loc 1 258 2 view .LVU224
 259:./Hardware/as5047.c **** 	while(data_2_cal != 0)
 721              		.loc 1 259 2 view .LVU225
 258:./Hardware/as5047.c **** 	uint16_t parity_bit_value=0;
 722              		.loc 1 258 11 is_stmt 0 view .LVU226
 723 0000 0023     		movs	r3, #0
 724              		.loc 1 259 7 view .LVU227
 725 0002 01E0     		b	.L40
 726              	.LVL51:
 727              	.L41:
 260:./Hardware/as5047.c **** 	{
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 19


 261:./Hardware/as5047.c **** 		parity_bit_value ^= data_2_cal; 
 728              		.loc 1 261 3 is_stmt 1 view .LVU228
 729              		.loc 1 261 20 is_stmt 0 view .LVU229
 730 0004 4340     		eors	r3, r3, r0
 731              	.LVL52:
 262:./Hardware/as5047.c **** 		data_2_cal >>=1;
 732              		.loc 1 262 3 is_stmt 1 view .LVU230
 733              		.loc 1 262 14 is_stmt 0 view .LVU231
 734 0006 4008     		lsrs	r0, r0, #1
 735              	.LVL53:
 736              	.L40:
 259:./Hardware/as5047.c **** 	while(data_2_cal != 0)
 737              		.loc 1 259 7 is_stmt 1 view .LVU232
 738 0008 0028     		cmp	r0, #0
 739 000a FBD1     		bne	.L41
 263:./Hardware/as5047.c **** 	}
 264:./Hardware/as5047.c **** 	return (parity_bit_value & 0x1); 
 740              		.loc 1 264 2 view .LVU233
 265:./Hardware/as5047.c **** }
 741              		.loc 1 265 1 is_stmt 0 view .LVU234
 742 000c 03F00100 		and	r0, r3, #1
 743              	.LVL54:
 744              		.loc 1 265 1 view .LVU235
 745 0010 7047     		bx	lr
 746              		.cfi_endproc
 747              	.LFE244:
 749              		.section	.text.SPI_ReadWrite_OneByte,"ax",%progbits
 750              		.align	1
 751              		.global	SPI_ReadWrite_OneByte
 752              		.syntax unified
 753              		.thumb
 754              		.thumb_func
 756              	SPI_ReadWrite_OneByte:
 757              	.LVL55:
 758              	.LFB245:
 266:./Hardware/as5047.c **** //SPIå‘é€è¯»å–å‡½æ•°
 267:./Hardware/as5047.c **** uint16_t SPI_ReadWrite_OneByte(uint16_t _txdata)
 268:./Hardware/as5047.c **** {
 759              		.loc 1 268 1 is_stmt 1 view -0
 760              		.cfi_startproc
 761              		@ args = 0, pretend = 0, frame = 16
 762              		@ frame_needed = 0, uses_anonymous_args = 0
 763              		.loc 1 268 1 is_stmt 0 view .LVU237
 764 0000 00B5     		push	{lr}
 765              	.LCFI5:
 766              		.cfi_def_cfa_offset 4
 767              		.cfi_offset 14, -4
 768 0002 87B0     		sub	sp, sp, #28
 769              	.LCFI6:
 770              		.cfi_def_cfa_offset 32
 771 0004 ADF80E00 		strh	r0, [sp, #14]	@ movhi
 269:./Hardware/as5047.c **** 
 270:./Hardware/as5047.c **** 	HAL_GPIO_WritePin(SPI3_SOFTCS_GPIO_Port,SPI3_SOFTCS_Pin,GPIO_PIN_RESET);	//csæ‹‰ä½
 772              		.loc 1 270 2 is_stmt 1 view .LVU238
 773 0008 0022     		movs	r2, #0
 774 000a 0121     		movs	r1, #1
 775 000c 0D48     		ldr	r0, .L45
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 20


 776              	.LVL56:
 777              		.loc 1 270 2 is_stmt 0 view .LVU239
 778 000e FFF7FEFF 		bl	HAL_GPIO_WritePin
 779              	.LVL57:
 271:./Hardware/as5047.c **** 	uint16_t rxdata;
 780              		.loc 1 271 2 is_stmt 1 view .LVU240
 272:./Hardware/as5047.c **** 	if(HAL_SPI_TransmitReceive(&hspi3,(uint8_t *)&_txdata,(uint8_t *)&rxdata,1,1000) !=HAL_OK)
 781              		.loc 1 272 2 view .LVU241
 782              		.loc 1 272 5 is_stmt 0 view .LVU242
 783 0012 4FF47A73 		mov	r3, #1000
 784 0016 0093     		str	r3, [sp]
 785 0018 0123     		movs	r3, #1
 786 001a 0DF11602 		add	r2, sp, #22
 787 001e 0DF10E01 		add	r1, sp, #14
 788 0022 0948     		ldr	r0, .L45+4
 789 0024 FFF7FEFF 		bl	HAL_SPI_TransmitReceive
 790              	.LVL58:
 791              		.loc 1 272 4 view .LVU243
 792 0028 10B1     		cbz	r0, .L43
 273:./Hardware/as5047.c ****     {
 274:./Hardware/as5047.c ****         rxdata=0;
 793              		.loc 1 274 9 is_stmt 1 view .LVU244
 794              		.loc 1 274 15 is_stmt 0 view .LVU245
 795 002a 0023     		movs	r3, #0
 796 002c ADF81630 		strh	r3, [sp, #22]	@ movhi
 797              	.L43:
 275:./Hardware/as5047.c ****     }
 276:./Hardware/as5047.c **** 	HAL_GPIO_WritePin(SPI3_SOFTCS_GPIO_Port,SPI3_SOFTCS_Pin,GPIO_PIN_SET);
 798              		.loc 1 276 2 is_stmt 1 view .LVU246
 799 0030 0122     		movs	r2, #1
 800 0032 1146     		mov	r1, r2
 801 0034 0348     		ldr	r0, .L45
 802 0036 FFF7FEFF 		bl	HAL_GPIO_WritePin
 803              	.LVL59:
 277:./Hardware/as5047.c **** 	return rxdata;
 804              		.loc 1 277 2 view .LVU247
 278:./Hardware/as5047.c **** }
 805              		.loc 1 278 1 is_stmt 0 view .LVU248
 806 003a BDF81600 		ldrh	r0, [sp, #22]
 807 003e 07B0     		add	sp, sp, #28
 808              	.LCFI7:
 809              		.cfi_def_cfa_offset 4
 810              		@ sp needed
 811 0040 5DF804FB 		ldr	pc, [sp], #4
 812              	.L46:
 813              		.align	2
 814              	.L45:
 815 0044 00000240 		.word	1073872896
 816 0048 00000000 		.word	hspi3
 817              		.cfi_endproc
 818              	.LFE245:
 820              		.section	.text.as5047_read,"ax",%progbits
 821              		.align	1
 822              		.global	as5047_read
 823              		.syntax unified
 824              		.thumb
 825              		.thumb_func
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 21


 827              	as5047_read:
 828              	.LFB246:
 279:./Hardware/as5047.c **** void* as5047_read(void)
 280:./Hardware/as5047.c **** {
 829              		.loc 1 280 1 is_stmt 1 view -0
 830              		.cfi_startproc
 831              		@ args = 0, pretend = 0, frame = 0
 832              		@ frame_needed = 0, uses_anonymous_args = 0
 833 0000 10B5     		push	{r4, lr}
 834              	.LCFI8:
 835              		.cfi_def_cfa_offset 8
 836              		.cfi_offset 4, -8
 837              		.cfi_offset 14, -4
 281:./Hardware/as5047.c ****     uint16_t add = 0;
 838              		.loc 1 281 5 view .LVU250
 839              	.LVL60:
 282:./Hardware/as5047.c **** 	uint16_t data;
 840              		.loc 1 282 2 view .LVU251
 283:./Hardware/as5047.c ****     add = ANGLEUNC;
 841              		.loc 1 283 5 view .LVU252
 284:./Hardware/as5047.c **** 	add |= 0x4000;	//è¯»æŒ‡ä»¤ bit14 ç½®1
 842              		.loc 1 284 2 view .LVU253
 285:./Hardware/as5047.c **** 	if(Parity_bit_Calculate(add)==1) 
 843              		.loc 1 285 2 view .LVU254
 844              		.loc 1 285 5 is_stmt 0 view .LVU255
 845 0002 47F6FE70 		movw	r0, #32766
 846 0006 FFF7FEFF 		bl	Parity_bit_Calculate
 847              	.LVL61:
 848              		.loc 1 285 4 view .LVU256
 849 000a 0128     		cmp	r0, #1
 850 000c 16D0     		beq	.L49
 284:./Hardware/as5047.c **** 	add |= 0x4000;	//è¯»æŒ‡ä»¤ bit14 ç½®1
 851              		.loc 1 284 6 view .LVU257
 852 000e 47F6FE70 		movw	r0, #32766
 853              	.L48:
 854              	.LVL62:
 286:./Hardware/as5047.c ****     {
 287:./Hardware/as5047.c ****         add=add|0x8000; //å¦‚æœå‰15ä½ 1çš„ä¸ªæ•°ä½å¶æ•°ï¼Œåˆ™Bit15 ç½®1
 288:./Hardware/as5047.c ****     }
 289:./Hardware/as5047.c **** 	SPI_ReadWrite_OneByte(add);		//å‘é€ä¸€æ¡æŒ‡ä»¤ï¼Œä¸ç®¡è¯»å›çš„æ•°æ®
 855              		.loc 1 289 2 is_stmt 1 view .LVU258
 856 0012 FFF7FEFF 		bl	SPI_ReadWrite_OneByte
 857              	.LVL63:
 290:./Hardware/as5047.c ****     data=SPI_ReadWrite_OneByte(0x4000); //å‘é€ä¸€æ¡ç©ºæŒ‡ä»¤ï¼Œè¯»å–ä¸Šä¸€æ¬¡æŒ‡ä»¤è¿”å›çš„æ•°
 858              		.loc 1 290 5 view .LVU259
 859              		.loc 1 290 10 is_stmt 0 view .LVU260
 860 0016 4FF48040 		mov	r0, #16384
 861 001a FFF7FEFF 		bl	SPI_ReadWrite_OneByte
 862              	.LVL64:
 291:./Hardware/as5047.c **** 	data &=0x3fff;
 863              		.loc 1 291 2 is_stmt 1 view .LVU261
 864              		.loc 1 291 7 is_stmt 0 view .LVU262
 865 001e C0F30D04 		ubfx	r4, r0, #0, #14
 866              	.LVL65:
 292:./Hardware/as5047.c **** 
 293:./Hardware/as5047.c ****     encoder_update(data);
 867              		.loc 1 293 5 is_stmt 1 view .LVU263
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 22


 868 0022 2046     		mov	r0, r4
 869 0024 FFF7FEFF 		bl	encoder_update
 870              	.LVL66:
 294:./Hardware/as5047.c **** 
 295:./Hardware/as5047.c ****     rawdata = data;
 871              		.loc 1 295 5 view .LVU264
 872              		.loc 1 295 13 is_stmt 0 view .LVU265
 873 0028 064B     		ldr	r3, .L51
 874 002a 1C60     		str	r4, [r3]
 296:./Hardware/as5047.c ****     covdata = data * 402;
 875              		.loc 1 296 5 is_stmt 1 view .LVU266
 876              		.loc 1 296 20 is_stmt 0 view .LVU267
 877 002c 4FF4C970 		mov	r0, #402
 878 0030 00FB04F4 		mul	r4, r0, r4
 879              	.LVL67:
 880              		.loc 1 296 13 view .LVU268
 881 0034 044B     		ldr	r3, .L51+4
 882              		.loc 1 296 13 view .LVU269
 883 0036 1C60     		str	r4, [r3]
 297:./Hardware/as5047.c **** 	return (void *)&sg_as5047data;
 884              		.loc 1 297 2 is_stmt 1 view .LVU270
 298:./Hardware/as5047.c **** }
 885              		.loc 1 298 1 is_stmt 0 view .LVU271
 886 0038 0448     		ldr	r0, .L51+8
 887 003a 10BD     		pop	{r4, pc}
 888              	.LVL68:
 889              	.L49:
 287:./Hardware/as5047.c ****     }
 890              		.loc 1 287 12 view .LVU272
 891 003c 4FF6FE70 		movw	r0, #65534
 892 0040 E7E7     		b	.L48
 893              	.L52:
 894 0042 00BF     		.align	2
 895              	.L51:
 896 0044 00000000 		.word	.LANCHOR11
 897 0048 00000000 		.word	.LANCHOR12
 898 004c 00000000 		.word	.LANCHOR13
 899              		.cfi_endproc
 900              	.LFE246:
 902              		.section	.text.as5047_init,"ax",%progbits
 903              		.align	1
 904              		.global	as5047_init
 905              		.syntax unified
 906              		.thumb
 907              		.thumb_func
 909              	as5047_init:
 910              	.LFB247:
 299:./Hardware/as5047.c **** 
 300:./Hardware/as5047.c **** void as5047_init(void)
 301:./Hardware/as5047.c **** {
 911              		.loc 1 301 1 is_stmt 1 view -0
 912              		.cfi_startproc
 913              		@ args = 0, pretend = 0, frame = 0
 914              		@ frame_needed = 0, uses_anonymous_args = 0
 915 0000 08B5     		push	{r3, lr}
 916              	.LCFI9:
 917              		.cfi_def_cfa_offset 8
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 23


 918              		.cfi_offset 3, -8
 919              		.cfi_offset 14, -4
 302:./Hardware/as5047.c ****     sg_as5047data.raw_buf = &rawdata;
 920              		.loc 1 302 5 view .LVU274
 921              		.loc 1 302 27 is_stmt 0 view .LVU275
 922 0002 054B     		ldr	r3, .L55
 923 0004 054A     		ldr	r2, .L55+4
 924 0006 1A60     		str	r2, [r3]
 303:./Hardware/as5047.c ****     sg_as5047data.covdata_buf = &covdata;
 925              		.loc 1 303 5 is_stmt 1 view .LVU276
 926              		.loc 1 303 31 is_stmt 0 view .LVU277
 927 0008 054A     		ldr	r2, .L55+8
 928 000a 5A60     		str	r2, [r3, #4]
 304:./Hardware/as5047.c ****     sg_as5047data.filterdata_buf = &filterdata;
 929              		.loc 1 304 5 is_stmt 1 view .LVU278
 930              		.loc 1 304 34 is_stmt 0 view .LVU279
 931 000c 054A     		ldr	r2, .L55+12
 932 000e 9A60     		str	r2, [r3, #8]
 305:./Hardware/as5047.c ****     MagneticSensor_Init();
 933              		.loc 1 305 5 is_stmt 1 view .LVU280
 934 0010 FFF7FEFF 		bl	MagneticSensor_Init
 935              	.LVL69:
 306:./Hardware/as5047.c **** }
 936              		.loc 1 306 1 is_stmt 0 view .LVU281
 937 0014 08BD     		pop	{r3, pc}
 938              	.L56:
 939 0016 00BF     		.align	2
 940              	.L55:
 941 0018 00000000 		.word	.LANCHOR13
 942 001c 00000000 		.word	.LANCHOR11
 943 0020 00000000 		.word	.LANCHOR12
 944 0024 00000000 		.word	.LANCHOR14
 945              		.cfi_endproc
 946              	.LFE247:
 948              		.global	vel_estimate_
 949              		.global	pos_estimate_
 950              		.global	vel_estimate_valid_
 951              		.global	pos_estimate_valid_
 952              		.global	encoder_config
 953              		.global	filterdata
 954              		.global	covdata
 955              		.global	rawdata
 956              		.section	.bss.covdata,"aw",%nobits
 957              		.align	2
 958              		.set	.LANCHOR12,. + 0
 961              	covdata:
 962 0000 00000000 		.space	4
 963              		.section	.bss.encoder_config,"aw",%nobits
 964              		.align	2
 965              		.set	.LANCHOR2,. + 0
 968              	encoder_config:
 969 0000 00000000 		.space	56
 969      00000000 
 969      00000000 
 969      00000000 
 969      00000000 
 970              		.section	.bss.filterdata,"aw",%nobits
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 24


 971              		.align	2
 972              		.set	.LANCHOR14,. + 0
 975              	filterdata:
 976 0000 00000000 		.space	4
 977              		.section	.bss.pll_ki_,"aw",%nobits
 978              		.align	2
 979              		.set	.LANCHOR4,. + 0
 982              	pll_ki_:
 983 0000 00000000 		.space	4
 984              		.section	.bss.pll_kp_,"aw",%nobits
 985              		.align	2
 986              		.set	.LANCHOR3,. + 0
 989              	pll_kp_:
 990 0000 00000000 		.space	4
 991              		.section	.bss.pos_cpr_counts_.2,"aw",%nobits
 992              		.align	2
 993              		.set	.LANCHOR6,. + 0
 996              	pos_cpr_counts_.2:
 997 0000 00000000 		.space	4
 998              		.section	.bss.pos_estimate_,"aw",%nobits
 999              		.align	2
 1000              		.set	.LANCHOR9,. + 0
 1003              	pos_estimate_:
 1004 0000 00000000 		.space	4
 1005              		.section	.bss.pos_estimate_counts_.0,"aw",%nobits
 1006              		.align	2
 1007              		.set	.LANCHOR8,. + 0
 1010              	pos_estimate_counts_.0:
 1011 0000 00000000 		.space	4
 1012              		.section	.bss.pos_estimate_valid_,"aw",%nobits
 1013              		.set	.LANCHOR1,. + 0
 1016              	pos_estimate_valid_:
 1017 0000 00       		.space	1
 1018              		.section	.bss.rawdata,"aw",%nobits
 1019              		.align	2
 1020              		.set	.LANCHOR11,. + 0
 1023              	rawdata:
 1024 0000 00000000 		.space	4
 1025              		.section	.bss.sg_as5047data,"aw",%nobits
 1026              		.align	2
 1027              		.set	.LANCHOR13,. + 0
 1030              	sg_as5047data:
 1031 0000 00000000 		.space	16
 1031      00000000 
 1031      00000000 
 1031      00000000 
 1032              		.section	.bss.shadow_count_.3,"aw",%nobits
 1033              		.align	2
 1034              		.set	.LANCHOR5,. + 0
 1037              	shadow_count_.3:
 1038 0000 00000000 		.space	4
 1039              		.section	.bss.vel_estimate_,"aw",%nobits
 1040              		.align	2
 1041              		.set	.LANCHOR10,. + 0
 1044              	vel_estimate_:
 1045 0000 00000000 		.space	4
 1046              		.section	.bss.vel_estimate_counts_.1,"aw",%nobits
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 25


 1047              		.align	2
 1048              		.set	.LANCHOR7,. + 0
 1051              	vel_estimate_counts_.1:
 1052 0000 00000000 		.space	4
 1053              		.section	.bss.vel_estimate_valid_,"aw",%nobits
 1054              		.set	.LANCHOR0,. + 0
 1057              	vel_estimate_valid_:
 1058 0000 00       		.space	1
 1059              		.text
 1060              	.Letext0:
 1061              		.file 2 "d:\\program files\\gcc-arm-none-eabi-10.3-2021.10\\arm-none-eabi\\include\\machine\\_defa
 1062              		.file 3 "d:\\program files\\gcc-arm-none-eabi-10.3-2021.10\\arm-none-eabi\\include\\sys\\_stdint.h
 1063              		.file 4 "Drivers/CMSIS/Device/ST/STM32F4xx/Include/stm32f405xx.h"
 1064              		.file 5 "Drivers/STM32F4xx_HAL_Driver/Inc/stm32f4xx_hal_def.h"
 1065              		.file 6 "Drivers/STM32F4xx_HAL_Driver/Inc/stm32f4xx_hal_gpio.h"
 1066              		.file 7 "Drivers/STM32F4xx_HAL_Driver/Inc/stm32f4xx_hal_dma.h"
 1067              		.file 8 "Drivers/STM32F4xx_HAL_Driver/Inc/stm32f4xx_hal_spi.h"
 1068              		.file 9 "Inc/spi.h"
 1069              		.file 10 "d:\\program files\\gcc-arm-none-eabi-10.3-2021.10\\arm-none-eabi\\include\\math.h"
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 26


DEFINED SYMBOLS
                            *ABS*:00000000 as5047.c
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:20     .text.encoder_set_error:00000000 $t
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:26     .text.encoder_set_error:00000000 encoder_set_error
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:49     .text.encoder_set_error:0000000c $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:55     .text.update_pll_gains:00000000 $t
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:61     .text.update_pll_gains:00000000 update_pll_gains
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:91     .text.update_pll_gains:00000024 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:98     .text.run_offset_calibration:00000000 $t
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:104    .text.run_offset_calibration:00000000 run_offset_calibration
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:133    .text.run_offset_calibration:00000014 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:139    .text.MagneticSensor_Init:00000000 $t
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:145    .text.MagneticSensor_Init:00000000 MagneticSensor_Init
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:221    .text.MagneticSensor_Init:00000048 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:230    .text.encoder_update:00000000 $t
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:236    .text.encoder_update:00000000 encoder_update
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:688    .text.encoder_update:00000200 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:706    .text.Parity_bit_Calculate:00000000 $t
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:712    .text.Parity_bit_Calculate:00000000 Parity_bit_Calculate
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:750    .text.SPI_ReadWrite_OneByte:00000000 $t
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:756    .text.SPI_ReadWrite_OneByte:00000000 SPI_ReadWrite_OneByte
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:815    .text.SPI_ReadWrite_OneByte:00000044 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:821    .text.as5047_read:00000000 $t
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:827    .text.as5047_read:00000000 as5047_read
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:896    .text.as5047_read:00000044 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:903    .text.as5047_init:00000000 $t
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:909    .text.as5047_init:00000000 as5047_init
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:941    .text.as5047_init:00000018 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1044   .bss.vel_estimate_:00000000 vel_estimate_
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1003   .bss.pos_estimate_:00000000 pos_estimate_
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1057   .bss.vel_estimate_valid_:00000000 vel_estimate_valid_
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1016   .bss.pos_estimate_valid_:00000000 pos_estimate_valid_
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:968    .bss.encoder_config:00000000 encoder_config
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:975    .bss.filterdata:00000000 filterdata
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:961    .bss.covdata:00000000 covdata
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1023   .bss.rawdata:00000000 rawdata
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:957    .bss.covdata:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:964    .bss.encoder_config:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:971    .bss.filterdata:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:978    .bss.pll_ki_:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:982    .bss.pll_ki_:00000000 pll_ki_
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:985    .bss.pll_kp_:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:989    .bss.pll_kp_:00000000 pll_kp_
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:992    .bss.pos_cpr_counts_.2:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:996    .bss.pos_cpr_counts_.2:00000000 pos_cpr_counts_.2
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:999    .bss.pos_estimate_:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1006   .bss.pos_estimate_counts_.0:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1010   .bss.pos_estimate_counts_.0:00000000 pos_estimate_counts_.0
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1017   .bss.pos_estimate_valid_:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1019   .bss.rawdata:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1026   .bss.sg_as5047data:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1030   .bss.sg_as5047data:00000000 sg_as5047data
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1033   .bss.shadow_count_.3:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1037   .bss.shadow_count_.3:00000000 shadow_count_.3
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1040   .bss.vel_estimate_:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1047   .bss.vel_estimate_counts_.1:00000000 $d
C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1051   .bss.vel_estimate_counts_.1:00000000 vel_estimate_counts_.1
ARM GAS  C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s 			page 27


C:\Users\57308\AppData\Local\Temp\ccsc3h8P.s:1058   .bss.vel_estimate_valid_:00000000 $d

UNDEFINED SYMBOLS
nearbyintf
HAL_GPIO_WritePin
HAL_SPI_TransmitReceive
hspi3
